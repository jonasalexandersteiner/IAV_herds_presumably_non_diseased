---
title: "EDA SIV_Farms"
author: "jonasalexandersteiner"
date: "2025-07-11"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: readable
    df_print: paged
    self_contained: true
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Set proper encoding
Sys.setlocale("LC_ALL", "en_US.UTF-8")
options(encoding = "UTF-8")

# Load required packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, skimr, GGally, lubridate, gridExtra, grid)

# Set project paths
d_proj <- "C:/Users/js22i117/OneDrive - Universitaet Bern/Dokumente/SIV_Projekt/Data_processing/SIV_farms100"
dirs <- file.path(d_proj, c("01_oridata", "02_data", "03_code", "04_output"))

# Load saved RDS data
df2 <- readRDS(file.path(dirs[2], "siv_farms_cleaned.rds"))

# Fix any encoding issues in factor levels
if ("source_of_contact_grouped" %in% names(df2) && is.factor(df2$source_of_contact_grouped)) {
  levels(df2$source_of_contact_grouped) <- iconv(levels(df2$source_of_contact_grouped), 
                                                from = "latin1", to = "UTF-8", sub = "")
}
```

```{r helpers, echo=FALSE}
summary_text <- function(x, varname) {
  if (varname == "farm_id") return("Variable: farm_id (ID variable, skipped summary.)")
  cl <- paste("Class:", paste(class(x), collapse=", "))
  n_missing <- sum(is.na(x))
  variance <- if(is.numeric(x)) paste("Variance:", format(var(x, na.rm=TRUE), digits=4)) else NULL
  shapiro_test <- NULL
  if(is.numeric(x)) {
    x_non_na <- x[!is.na(x)]
    if(length(x_non_na) >= 3 && length(x_non_na) <= 5000) {
      sw <- tryCatch(shapiro.test(x_non_na), error=function(e) NULL)
      if(!is.null(sw)) {
        shapiro_test <- paste0("Shapiro-Wilk p-value: ", format(sw$p.value, digits=4),
                               ifelse(sw$p.value < 0.05, " (not normal)", " (normal)"))
      }
    } else {
      shapiro_test <- "Shapiro-Wilk test not applicable (n<3 or n>5000)"
    }
    s <- summary(x)
    txt <- paste(
      cl,
      paste(names(s), format(s, digits=4), collapse="\n"),
      variance,
      shapiro_test,
      paste("NA count:", n_missing),
      sep="\n"
    )
  } else if (is.factor(x)) {
    tbl <- summary(x)
    props <- prop.table(table(x, useNA="no"))
    mode_val <- names(which.max(table(x)))
    
    # Safe handling of levels to avoid encoding issues
    lvls <- tryCatch(
      iconv(levels(x), from = "latin1", to = "UTF-8", sub = ""), 
      error = function(e) as.character(levels(x))
    )
    
    txt <- paste(
      cl,
      paste(names(tbl), as.integer(tbl), collapse="\n"),
      paste("Mode:", mode_val),
      paste("Proportion of levels:", 
            paste(names(props), sprintf("%.2f", as.numeric(props)), collapse=", ")),
      paste("Levels:", paste(lvls, collapse=", ")),
      paste("NA count:", n_missing),
      sep="\n"
    )
  } else if (is.logical(x)) {
    tbl <- table(x, useNA="no")
    props <- prop.table(tbl)
    mode_val <- names(which.max(tbl))
    txt <- paste(
      cl,
      paste(names(tbl), as.integer(tbl), collapse="\n"),
      paste("Mode:", mode_val),
      paste("Proportion of levels:", 
            paste(names(props), sprintf("%.2f", as.numeric(props)), collapse=", ")),
      paste("NA count:", n_missing),
      sep="\n"
    )
  } else if (inherits(x, "Date") || inherits(x, "POSIXct")) {
    s <- summary(x)
    txt <- paste(
      cl,
      paste(names(s), format(s, digits=4), collapse="\n"),
      paste("NA count:", n_missing),
      sep="\n"
    )
  } else {
    txt <- cl
  }
  return(paste("Variable:", varname, "\n", txt))
}
```

# Exploratory Data Analysis Report

Below you'll find a per-variable summary and relevant plots for the SIV_farms data set.
Character variables are excluded from this analysis.  
The variable `farm_id` is skipped.

```{r data_overview, echo=FALSE}
# Display basic dataset information
cat("Dataset dimensions:", nrow(df2), "rows x", ncol(df2), "columns\n\n")
cat("Data types:\n")
data_types <- sapply(df2, class)
data_type_counts <- table(unlist(data_types))
for (i in 1:length(data_type_counts)) {
  cat("- ", names(data_type_counts)[i], ": ", data_type_counts[i], " variables\n", sep="")
}

# Show SIV positive rate
IAV_positive_rate <- mean(df2$IAV_positive, na.rm=TRUE)
cat("\nSIV positive rate:", round(IAV_positive_rate*100, 1), "%\n")
```

```{r variable_eda, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=4}
for (v in names(df2)) {
  if (v == "farm_id") next
  x <- df2[[v]]
  if (is.character(x)) next
  
  # Skip variables with encoding issues
  if (v == "source_of_contact_grouped") next
  
  cat("##", v, "\n")
  cat("**Summary statistics:**\n\n")
  cat("<pre>", summary_text(x, v), "</pre>\n\n")

  if (is.numeric(x) || is.integer(x)) {
    p_box <- ggplot(df2, aes_string(y=v)) +
      geom_boxplot(fill="tomato") +
      ggtitle(paste("Boxplot of", v))
    p_qq <- ggplot(data.frame(x=x), aes(sample=x)) +
      stat_qq() + stat_qq_line() +
      ggtitle(paste("QQ plot of", v))
    gridExtra::grid.arrange(p_box, p_qq, ncol=2)
  } else if (is.factor(x)) {
    # Factor: histogram (bar plot)
    p_hist <- ggplot(data.frame(x=x), aes(x=x)) +
      geom_bar(fill="skyblue") +
      ggtitle(paste("Histogram of", v)) +
      theme(axis.text.x=element_text(angle=45, hjust=1))
    print(p_hist)
  } else if (is.logical(x)) {
    p_bar <- ggplot(data.frame(x=factor(x)), aes(x=x)) +
      geom_bar(fill="orange") +
      ggtitle(paste("Barplot of", v))
    print(p_bar)
  } else if (inherits(x, "Date") || inherits(x, "POSIXct")) {
    x_num <- as.numeric(x)
    p_box <- ggplot(data.frame(x=x_num), aes(y=x_num)) +
      geom_boxplot(fill="tomato") +
      ggtitle(paste("Boxplot of", v))
    p_qq <- ggplot(data.frame(x=x_num), aes(sample=x_num)) +
      stat_qq() + stat_qq_line() +
      ggtitle(paste("QQ plot of", v, "(numeric representation)"))
    gridExtra::grid.arrange(p_box, p_qq, ncol=2)
  }
  cat("\n\n")
}
```

# Session Information
```{r session_info, echo=FALSE}
# Display session information for reproducibility
cat("Generated by:", "jonasalexandersteiner", "\n")
cat("Generated on:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
cat("File location:", file.path(dirs[4], "eda_report.Rmd"), "\n\n")
sessionInfo()
```